<tables>
	<table>
		<name>DIAGNOSIS_EVENT_FACT</name>
		<type>Fact</type>
		<displayName>Diagnosis Event Fact</displayName>
		<description>The diagnosis event fact contains information about diagnoses attributed to patients.</description>
		<scripts>
			<!--
			If we anticipate multiple scripts being executed for a table during the same stage (i.e. Extract, Transform, Load, and others as we define), then
			we may need to introduce other attributes such as order and, possibly, dependsOn. There could also be value of a name element or leveraging
			idref's to assist with dependencies.
			-->
			<script stage="Extract" connection="Clarity"><![CDATA[
				SELECT
					PAT_ENC_DX.PAT_ENC_CSN_ID,
					PAT_ENC_DX.LINE,
					PAT_ENC_DX.PAT_ID,
					PAT_ENC_DX.DX_ID,
					PAT_ENC_DX.DX_CHRONIC_YN,
					PAT_ENC_DX.DX_ED_YN,
					PAT_ENC_DX.PRIMARY_DX_YN,
					PAT_ENC.EFFECTIVE_DATE_DTTM,
					PAT_ENC.ENC_TYPE_C,
					PAT_ENC_HSP.ED_DEPARTURE_TIME,
					PAT_ENC_HSP.ED_EPISODE_ID,
					PAT_ENC_HSP.HOSP_DISCH_TIME,
					PAT_ENC_HSP.INP_ADM_DATE
				FROM PAT_ENC_DX
					LEFT OUTER JOIN PAT_ENC ON PAT_ENC_DX.PAT_ENC_CSN_ID = PAT_ENC.PAT_ENC_CSN_ID
					LEFT OUTER JOIN PAT_ENC_HSP ON PAT_ENC_DX.PAT_ENC_CSN_ID = PAT_ENC_HSP.PAT_ENC_CSN_ID
				WHERE PAT_ENC_DX.PAT_ENC_CSN_ID IN (
						SELECT PAT_ENC_CSN_ID FROM #CSA_PAT_ENC_DX UNION
						SELECT PAT_ENC_CSN_ID FROM #CSA_PAT_ENC UNION
						SELECT PAT_ENC_CSN_ID FROM #CSA_PAT_ENC_HSP
					)
			]]></script>
		</scripts>
		<columns>
			<column>
				<name>DIAGNOSIS_EVENT_KEY</name>
				<displayName>Diagnosis event key</displayName>
				<description>Diagnosis event key.</description>
				<dataType type="NUMBER" />
				<scdType>1</scdType>
			</column>
			<column>
				<name>DIAGNOSIS_KEY</name>
				<displayName>Diagnosis key</displayName>
				<description>Diagnosis key.</description>
				<dataType type="NUMBER" />
				<foreignKeyTable>DIAGNOSIS_DIM</foreignKeyTable>
				<nullable>false</nullable>
				<scdType>1</scdType>
			</column>
			<column>
				<name>PATIENT_KEY</name>
				<displayName>Patient key</displayName>
				<description>Patient key.</description>
				<dataType type="NUMBER" />
				<foreignKeyTable>PATIENT_DIM</foreignKeyTable>
				<nullable>false</nullable>
				<scdType>1</scdType>
			</column>
			<column>
				<name>ENCOUNTER_KEY</name>
				<displayName>Encounter key</displayName>
				<description>Encounter key.</description>
				<dataType type="NUMBER" />
				<foreignKeyTable>ENCOUNTER_FACT</foreignKeyTable>
				<nullable>false</nullable>
				<scdType>1</scdType>
			</column>
			<column>
				<name>EPIC_PAT_ENC_CSN_ID</name>
				<displayName>Epic encounter identifier</displayName>
				<description>Epic ID for the encounter identifier.</description>
				<dataType type="NUMBER" />
				<nullable>false</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_DX</table>
						<column>PAT_ENC_CSN_ID</column>
						<dataType type="NUMBER" />
					</source>
				</sources>
			</column>
			<column>
				<name>EPIC_LINE</name>
				<displayName>Epic diagnosis line number</displayName>
				<description>Epic ID for the diagnosis line identifier.</description>
				<dataType type="NUMBER" />
				<nullable>false</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_DX</table>
						<column>LINE</column>
						<dataType type="NUMBER" />
					</source>
				</sources>
			</column>
			<column>
				<name>EPIC_DX_ID</name>
				<displayName>Epic diagnosis ID</displayName>
				<description>Epic ID for the diagnosis identifier.</description>
				<dataType type="NUMBER" />
				<nullable>false</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_DX</table>
						<column>DX_ID</column>
						<dataType type="NUMBER" />
					</source>
				</sources>
			</column>
			<column>
				<name>EPIC_PAT_ID</name>
				<displayName>Epic patient ID</displayName>
				<description>Epic ID for the patient identifier.</description>
				<dataType type="VARCHAR2" size="18" />
				<nullable>false</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_DX</table>
						<column>PAT_ID</column>
						<dataType type="VARCHAR" size="18" />
					</source>
				</sources>
			</column>
			<column>
				<name>EVENT_START_AT</name>
				<displayName>Event start date</displayName>
				<description>Event start date.</description>
				<dataType type="DATE" />
				<nullable>false</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC</table>
						<column>EFFECTIVE_DATE_DTTM</column>
						<dataType type="DATE" />
					</source>
				</sources>
			</column>
			<column>
				<name>EVENT_END_AT</name>
				<displayName>Event end date</displayName>
				<description>Event end date.</description>
				<dataType type="DATE" />
				<nullable>true</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC</table>
						<column>EFFECTIVE_DATE_DTTM</column>
						<dataType type="DATE" />
						<identifiers>
							<identifier>EPT 87314</identifier>
							<identifier>EPT 87317</identifier>
						</identifiers>
						<etlNotes><![CDATA[
							If ENC_TYPE_C <> 3 - Hospital Encounter then EFFECTIVE_DATE_DTTM
							Otherwise if INP_ADM_DATE is not NULL then HOSP_DISCH_TIME
							Otherwise if ED_EPISODE_ID is not NULL then
							  If HOSP_DISCH_TIME is not NULL then HOSP_DISCH_TIME
							  Otherwise ED_DEPARTURE_TIME
							Otherwise
							  If HOSP_DISCH_TIME is not NULL then HOSP_DISCH_TIME
							  Otherwise EFFECTIVE_DATE_DTTM
						]]></etlNotes>
					</source>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC</table>
						<column>ENC_TYPE_C</column>
						<dataType type="NUMBER" />
						<identifiers>
							<identifier>EPT 30</identifier>
						</identifiers>
					</source>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_HSP</table>
						<column>ED_DEPARTURE_TIME</column>
						<dataType type="DATE" />
						<identifiers>
							<identifier>EPT 49020</identifier>
							<identifier>EPT 49025</identifier>
						</identifiers>
					</source>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_HSP</table>
						<column>ED_EPISODE_ID</column>
						<dataType type="DATE" />
						<identifiers>
							<identifier>EPT 1953 (HSB .1)</identifier>
						</identifiers>
					</source>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_HSP</table>
						<column>HOSP_DISCH_TIME</column>
						<dataType type="DATE" />
						<identifiers>
							<identifier>EPT 18855</identifier>
							<identifier>EPT 18856</identifier>
						</identifiers>
					</source>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_HSP</table>
						<column>INP_ADM_DATE</column>
						<dataType type="DATE" />
						<identifiers>
							<identifier>EPT 10290</identifier>
							<identifier>EPT 10291</identifier>
						</identifiers>
					</source>
				</sources>
			</column>
			<column>
				<name>TYPE</name>
				<displayName>Event type</displayName>
				<description>Event type.</description>
				<dataType type="VARCHAR2" size="350" />
				<nullable>false</nullable>
				<defaultValue>Encounter Diagnosis</defaultValue>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Derived</connection>
						<etlNotes>"Encounter Diagnosis"</etlNotes>
					</source>
				</sources>
			</column>
			<column>
				<name>PRESENT_ON_ADMISSION</name>
				<displayName>Present on admission</displayName>
				<description>Diagnosis present on admission.</description>
				<dataType type="VARCHAR2" size="300" />
				<nullable>false</nullable>
				<defaultValue>*Not Applicable</defaultValue>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Derived</connection>
						<etlNotes>"*Not Applicable"</etlNotes>
					</source>
				</sources>
			</column>
			<column>
				<name>HOSPITAL_DIAGNOSIS_IND</name>
				<displayName>Hospital diagnosis indicator</displayName>
				<description>Indicator to represent a diagnosis during a hospitalization.</description>
				<dataType type="NUMBER" size="1" />
				<nullable>true</nullable>
				<scdType>1</scdType>
			</column>
			<column>
				<name>EMERGENCY_DEPARTMENT_IND</name>
				<displayName>Emergency department diagnosis indicator</displayName>
				<description>Indicator to represent a diagnosis during an emergency department visit.</description>
				<dataType type="NUMBER" size="1" />
				<nullable>true</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_DX</table>
						<column>DX_ED_YN</column>
						<dataType type="VARCHAR" size="1" />
						<etlNotes><![CDATA[
							If DX_ED_YN is Y then 1
							Otherwise if DX_ED_YN is N then 0
							Otherwise NULL
						]]></etlNotes>
					</source>
				</sources>
			</column>
			<column>
				<name>CHRONIC_IND</name>
				<displayName>Chronic diagnosis indicator</displayName>
				<description>Chronic indicator.</description>
				<dataType type="NUMBER" size="1" />
				<nullable>true</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_DX</table>
						<column>DX_CHRONIC_YN</column>
						<dataType type="VARCHAR" size="1" />
						<etlNotes><![CDATA[
							If DX_CHRONIC_YN = Y then 1
							Otherwise if DX_CHRONIC_YN is N then 0
							Otherwise NULL
						]]></etlNotes>
					</source>
				</sources>
			</column>
			<column>
				<name>PRIMARY_IND</name>
				<displayName>Primary diagnosis indicator</displayName>
				<description>Primary diagnosis indicator.</description>
				<dataType type="NUMBER" size="1" />
				<nullable>true</nullable>
				<scdType>1</scdType>
				<sources>
					<source>
						<connection>Clarity</connection>
						<table>PAT_ENC_DX</table>
						<column>PRIMARY_DX_YN</column>
						<dataType type="VARCHAR" size="1" />
						<etlNotes><![CDATA[
							If PRIMARY_DX_YN is Y then 1
							Otherwise if PRIMARY_DX_YN is N then 0
							Otherwise NULL
						]]></etlNotes>
					</source>
				</sources>
			</column>
		</columns>
	</table>
</tables>
